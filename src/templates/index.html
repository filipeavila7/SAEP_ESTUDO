<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <link rel="stylesheet" href="static/style.css">
    </head>
    <body>
        <header class="header">
            <div class="cabecalho">
                <img src alt="logo">
                <h1>PET AMIGOS</h1>
                {% if current_user.is_authenticated %}
                <!-- Usu√°rio logado ‚Üí mostra bot√£o de logout -->
                <a href="{{ url_for('logout') }}">
                    <button>Logout</button>
                </a>
                {% else %}
                <!-- Usu√°rio n√£o logado ‚Üí mostra bot√£o de login -->
                <button id="abrirModal">Login</button>
                {% endif %}
            </div>

            <nav class="nav-bar">
                <ul class="nav-links">
                    <li><a href>Home</a></li>
                    <li><a href>Produtos</a></li>
                    <li><a href>Pets</a></li>
                    <li><a href>Servi√ßos</a></li>
                    <li><a href>Contato</a></li>
                </ul>
            </nav>
        </header>

        <section class="home-section">
            <div class="home-content">
                Bem vindo ao Pet Amigos
            </div>
            <button>Conhecer</button>

        </section>

        <section class="prod-section">
            <h2>Produtos</h2>
            <div class="prod-container">

                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
                <div class="card-prod">
                    <img src alt>
                    <h3>nome</h3>
                    <p>valor</p>
                </div>
            </div>
        </section>

        <!-- Modal -->
        <div id="modalLogin" class="modal">
            <div class="modal-conteudo">
                <span class="fechar">&times;</span>
                <h2>Entrar</h2>
                <form action="{{url_for('login')}}" method="post">
                    <input type="email" name="email" placeholder="E-mail"
                        required>
                    <input type="password" name="senha" placeholder="Senha"
                        required>
                    <button type="submit">Entrar</button>
                </form>
            </div>
        </div>

        <section class="pet-sec">
            <h2>Pets</h2>
            <div class="pet-container">
                <div class="card-pet" data-post-id="1">
                    <div class="pet-content">
                        <img src="static/img/gato.jpg" alt>
                        <div class="acoes">
                            <img src="static/img/heart.png" class="curtir-btn"
                                onclick="curtirPost(1, this)">
                            <span class="total-curtidas">0</span>
                            <img src="static/img/coment.png" alt="comentario"
                                onclick="abrirComentarios(1)">
                        </div>
                    </div>
                </div>

                <div class="card-pet" data-post-id="2">
                    <div class="pet-content">
                        <img
                            src="static/img/raca-de-cachorro-que-parece-um-lobo.jpg"
                            alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(2, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(2)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="3">
                    <div class="pet-content">
                        <img src="static/img/Pastor-3x4.jpg" alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(3, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(3)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="4">
                    <div class="pet-content">
                        <img src="static/img/preto.jpeg" alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(4, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(4)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="5">
                    <div class="pet-content">
                        <img src="static/img/image.png" alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(5, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(5)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="6">
                    <div class="pet-content">
                        <img
                            src="static/img/guia_racas_golden_retriever_dogvibe.jpg"
                            alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(6, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(6)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="7">
                    <div class="pet-content">
                        <img src="static/img/cachorro-que-parece-lobo.jpg" alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(7, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(7)">
                    </div>
                </div>
                <div class="card-pet" data-post-id="8">
                    <div class="pet-content">
                        <img src="static/img/gato2.jpg" alt>
                    </div>
                    <div class="acoes">
                        <img src="static/img/heart.png" class="curtir-btn"
                            onclick="curtirPost(8, this)">
                        <span class="total-curtidas">0</span>
                        <img src="static/img/coment.png" alt="comentario"
                            onclick="abrirComentarios(8)">
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal de coment√°rios -->
        <div id="modalComentarios" class="modal-comentario" data-post-id>
            <div class="modal-conteudo">
                <span class="fechar-comentario">&times;</span>
                <h2>Coment√°rios</h2>
                <div id="comentarios-lista"></div>

                <form id="form-comentario">
                    <textarea id="comentario-texto"
                        placeholder="Escreva um coment√°rio..."></textarea>
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </div>

        <script src="{{ url_for('static', filename='script.js') }}"></script>
        <script>
            //  Carregar curtidas ao abrir a p√°gina
            (async function carregarCurtidas() {
                console.log("üîÑ Iniciando fetch de curtidas...");
                
                try {
                    const response = await fetch("/curtidas_usuario");
                    if (!response.ok) throw new Error("Erro na requisi√ß√£o");

                    const curtidas = await response.json();
                    console.log("Dados recebidos:", curtidas);

                    // Atualiza os cora√ß√µes dos cards
                    document.querySelectorAll(".card-pet").forEach(card => {
                        const postId = card.dataset.postId;
                        const btn = card.querySelector(".curtir-btn");

                        if (!btn) return;

                        if (curtidas[postId]) {
                            btn.src = "static/img/curtido.png";
                            btn.classList.add("curtido");
                            console.log(`‚ù§Ô∏è Post ${postId} est√° curtido`);
                        } else {
                            btn.src = "static/img/heart.png";
                            btn.classList.remove("curtido");
                            console.log(`ü§ç Post ${postId} n√£o est√° curtido`);
                        }
                    });

                } catch (error) {
                    console.error("üí• Erro ao carregar curtidas:", error);
                }
            })();


                async function atualizarTotais() {
                try {
                    const response = await fetch("/total_curtidas");
                    const totais = await response.json();
                    console.log("üìä Totais recebidos:", totais);

                    document.querySelectorAll(".card-pet").forEach(card => {
                        const postId = card.dataset.postId; // string
                        const span = card.querySelector(".total-curtidas");
                        if (span) {
                            span.textContent = totais[postId] || 0;
                        }
                    });
                } catch (err) {
                    console.error("üí• Erro ao atualizar totais:", err);
                }
            }

            // chama a fun√ß√£o para atualizar quando a p√°gina carrega
            atualizarTotais();







                    // üì© Enviar coment√°rio
                    document.getElementById('form-comentario').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    console.log("üöÄ Evento de envio de coment√°rio acionado!");

                    const modal = document.getElementById('modalComentarios'); // ‚úÖ usar o mesmo ID que abrirComentarios
                    if (!modal) {
                        console.error("‚ùå Modal de coment√°rios n√£o encontrado!");
                        return;
                    }

                    const postId = modal.dataset.postId;
                    if (!postId) {
                        console.error("‚ùå Post ID n√£o definido no modal!");
                        return;
                    }

                    const textoInput = document.getElementById('comentario-texto');
                    const texto = textoInput.value.trim();

                    console.log("üÜî Post ID:", postId);
                    console.log("üìù Texto digitado:", texto);

                    if (!texto) {
                        console.warn("‚ö†Ô∏è Nenhum texto foi digitado!");
                        alert("Escreva algo antes de enviar!");
                        return;
                    }

                    const formData = new FormData();
                    formData.append("texto", texto);

                    console.log("üì¶ Dados preparados para envio:", [...formData.entries()]);

                    try {
                        console.log(`üì° Enviando requisi√ß√£o para /comentario/${postId}...`);

                        const response = await fetch(`/comentario/${postId}`, {
                            method: "POST",
                            body: formData
                        });

                        console.log("üì¨ Resposta recebida:", response);

                        if (!response.ok) {
                            console.error("‚ùå Erro HTTP:", response.status, response.statusText);
                            alert("Erro na comunica√ß√£o com o servidor.");
                            return;
                        }

                        const data = await response.json();
                        console.log("üì® Dados retornados do backend:", data);

                        if (data.success) {
                            console.log("‚úÖ Coment√°rio adicionado com sucesso!");
                            textoInput.value = ""; // limpa o campo
                            abrirComentarios(postId); // üîÑ atualiza lista
                        } else {
                            console.warn("‚ö†Ô∏è Erro ao adicionar coment√°rio:", data.mensagem);
                            alert(data.mensagem || "Erro ao enviar coment√°rio.");
                        }

                    } catch (error) {
                        console.error("üí• Erro inesperado ao enviar coment√°rio:", error);
                        alert("Erro inesperado. Veja o console para mais detalhes.");
                    }
                });



                function abrirComentarios(postId) {
                const modal = document.getElementById('modalComentarios');
                const lista = document.getElementById('comentarios-lista');

                // Mostra mensagem de carregamento
                lista.innerHTML = "<p>Carregando...</p>";

                // Abre o modal
                modal.style.display = "flex";

                // Atualiza o postId no modal
                modal.dataset.postId = postId;

                // Busca os coment√°rios via fetch
                fetch(`/comentarios/${postId}`)
                    .then(res => res.json())
                    .then(comentarios => {
                        if (comentarios.length) {
                            // Lista os coment√°rios
                            lista.innerHTML = comentarios
                                .map(c => `<p><strong>${c.usuario_nome}:</strong> ${c.texto}</p>`)
                                .join('');
                        } else {
                            lista.innerHTML = "<p>Seja o primeiro a comentar!</p>";
                        }
                        console.log("üìÑ Coment√°rios carregados:", comentarios);
                    })
                    .catch(err => {
                        console.error("üí• Erro ao carregar coment√°rios:", err);
                        lista.innerHTML = "<p>Erro ao carregar coment√°rios.</p>";
                    });

                    // Seleciona o modal e o bot√£o de fechar

                    const fecharBtn = document.querySelector('.fechar-comentario');

                    if (fecharBtn && modal) {
                        fecharBtn.onclick = () => {
                            modal.style.display = 'none';
                        };
                    }

                    // Fecha ao clicar fora do modal
                    window.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });

                
            }



        </script>
    </body>
</html>